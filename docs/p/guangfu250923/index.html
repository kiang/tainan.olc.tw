<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>花蓮光復救災資訊地圖</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="style.css" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FJ1JR851SJ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-FJ1JR851SJ');
    </script>
</head>
<body>
    <div id="map"></div>
    
    <!-- Tutorial Mode Dropdown at Top-Center -->
    <div id="tutorial-dropdown-container">
        <label for="tutorial-dropdown" class="tutorial-dropdown-label">教學</label>
        <select id="tutorial-dropdown" onchange="startTutorial(this.value)">
            <option value="">請選擇類型...</option>
            <option value="需要志工">需要志工</option>
            <option value="需要物資">需要物資</option>
            <option value="提供洗澡點">提供洗澡點</option>
            <option value="提供住宿點">提供住宿點</option>
            <option value="其他">其他</option>
        </select>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay">
        <div id="tutorial-steps">
            <h4 id="tutorial-title">步驟 1：選擇地點</h4>
            <p id="tutorial-description">請在地圖上點擊您要回報的位置</p>
        </div>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" onclick="openSidebar()">
        <i class="bi bi-list"></i> 圖層列表
    </button>
    
    <!-- Sidebar Panel -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h5 class="sidebar-title">救災資訊列表</h5>
            <button class="sidebar-close" onclick="closeSidebar()" aria-label="關閉">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" onclick="switchTab('submissions')" data-tab="submissions">
                🆘 緊急需求
            </button>
            <button class="sidebar-tab" onclick="switchTab('submissions2')" data-tab="submissions2">
                🏠 提供資源
            </button>
            <button class="sidebar-tab" onclick="switchTab('government')" data-tab="government">
                🏛️ 服務設施
            </button>
            <button class="sidebar-tab" onclick="switchTab('targets')" data-tab="targets">
                🎯 救災目標
            </button>
        </div>
        <div class="sidebar-content">
            <div id="submissions-pane" class="tab-pane active">
                <div class="filter-container">
                    <input type="text" class="filter-input" id="submissions-filter" placeholder="搜尋緊急需求..." onkeyup="filterDataList('submissions')">
                    <button class="filter-clear" onclick="clearFilter('submissions')" title="清除搜尋">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div class="list-counter">載入中...</div>
                <ul class="data-list" id="submissions-list"></ul>
            </div>
            <div id="submissions2-pane" class="tab-pane">
                <div class="filter-container">
                    <input type="text" class="filter-input" id="submissions2-filter" placeholder="搜尋提供資源..." onkeyup="filterDataList('submissions2')">
                    <button class="filter-clear" onclick="clearFilter('submissions2')" title="清除搜尋">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div class="list-counter">載入中...</div>
                <ul class="data-list" id="submissions2-list"></ul>
            </div>
            <div id="government-pane" class="tab-pane">
                <div class="filter-container">
                    <input type="text" class="filter-input" id="government-filter" placeholder="搜尋服務設施..." onkeyup="filterDataList('government')">
                    <button class="filter-clear" onclick="clearFilter('government')" title="清除搜尋">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div class="list-counter">載入中...</div>
                <ul class="data-list" id="government-list"></ul>
            </div>
            <div id="targets-pane" class="tab-pane">
                <div class="targets-form-container">
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScLTif33-ans7aChSyWS9NYre10WnX7RbtH1hSbgD35DHTdHQ/viewform"
                       target="_blank"
                       class="btn btn-sm btn-primary w-100 targets-form-link">
                        <i class="bi bi-pencil-square"></i> 協助通報
                    </a>
                </div>
                <div class="filter-container">
                    <input type="text" class="filter-input" id="targets-filter" placeholder="搜尋救災目標..." onkeyup="filterDataList('targets')">
                    <button class="filter-clear" onclick="clearFilter('targets')" title="清除搜尋">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div class="list-counter">載入中...</div>
                <ul class="data-list" id="targets-list"></ul>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-light">
        <div class="container-fluid">
            <div class="row w-100">
                <div class="col-md-8 mb-2 mb-md-0">
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" type="button" id="locate-me">
                            <i class="bi bi-geo-alt"></i> 定位
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="input-coordinates">
                            <i class="bi bi-geo"></i> 座標
                        </button>
                    </div>
                </div>
                <div class="col-md-4 d-flex justify-content-md-end align-items-center">
                    <small class="text-muted me-2">
                        <a href="https://facebook.com/k.olc.tw/" target="_blank" class="text-decoration-none">江明宗 製作</a>
                    </small>
                    <button id="tutorial-icon" class="btn btn-outline-info">
                        <i class="bi bi-play-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    <div id="tutorial-popup" class="tutorial-popup">
        <span class="tutorial-closer" id="tutorial-closer">&times;</span>
        <div id="tutorial-content">
            <h5 class="mb-3">花蓮光復救災資訊地圖使用教學</h5>
            <div class="mb-4">
                <h6>地圖功能說明：</h6>
                <ul>
                    <li><strong>行政區域</strong>：點擊村里區域可查看行政資訊並填寫救災表單</li>
                    <li><strong>救災標記</strong>：地圖上的彩色標記代表不同類型的救災資訊，採用群組顯示提升瀏覽效能</li>
                    <li><strong>村里名稱</strong>：放大地圖至13倍以上可看到村里名稱標籤</li>
                    <li><strong>自動分層</strong>：系統會根據救災資訊類型自動分層顯示，預設顯示緊急需求</li>
                </ul>
            </div>
            <div class="mb-4">
                <h6>資訊分層系統：</h6>
                <ul>
                    <li><strong>🆘 緊急需求</strong>：需要志工、需要物資等急迫性救災需求</li>
                    <li><strong>🏠 提供資源</strong>：提供洗澡點、提供住宿點等資源協助</li>
                    <li><strong>🏛️ 服務設施</strong>：流動廁所、沐浴站、取水站、物資站、醫療站、疫苗接種站、寵物義診、志工服務站、安心關懷站</li>
                    <li><strong>🎯 救災目標</strong>：清理進度追蹤，優先級分級管理（1級最優先）</li>
                </ul>
            </div>
            <div class="mb-4">
                <h6>救災標記圖例：</h6>
                <ul class="legend-list">
                    <li><span class="legend-item-volunteer">🙋</span> <strong>需要志工</strong> - 志工支援需求</li>
                    <li><span class="legend-item-supplies">📦</span> <strong>需要物資</strong> - 物資補給需求</li>
                    <li><span class="legend-item-shower">🚿</span> <strong>提供洗澡點</strong> - 盥洗設施</li>
                    <li><span class="legend-item-accommodation">🏠</span> <strong>提供住宿點</strong> - 臨時住宿</li>
                    <li><span class="legend-item-other">❓</span> <strong>其他</strong> - 其他救災資訊</li>
                    <li><span class="legend-item-meal">🍱</span> <strong>餐食發放</strong> - 政府提供餐食服務</li>
                </ul>
                <h6 class="priority-heading">救災目標優先級：</h6>
                <ul class="legend-list">
                    <li><span class="priority-badge priority-1">1</span> <strong>1級-2級</strong> - 最高優先（急需協助）</li>
                    <li><span class="priority-badge priority-3">3</span> <strong>3級</strong> - 中高優先</li>
                    <li><span class="priority-badge priority-4">4</span> <strong>4級</strong> - 中優先</li>
                    <li><span class="priority-badge priority-5">5</span> <strong>5級</strong> - 低優先</li>
                    <li><span class="priority-badge priority-6">6</span> <strong>6級</strong> - 最低優先（已清理完成）</li>
                </ul>
            </div>
            <div class="mb-4">
                <h6>智慧導航功能：</h6>
                <ul>
                    <li><strong>URL分享</strong>：複製網址可直接分享特定救災資訊給他人</li>
                    <li><strong>自動切換</strong>：點擊分享連結時系統會自動切換到正確分層並定位到該資訊</li>
                    <li><strong>群組展開</strong>：被群組的標記會自動展開並顯示目標資訊</li>
                </ul>
            </div>
            <div class="mb-4">
                <h6>操作說明：</h6>
                <ul>
                    <li><strong>定位</strong>：點擊「定位」按鈕找到您的當前位置</li>
                    <li><strong>座標跳轉</strong>：點擊「座標」按鈕輸入經緯度跳轉到特定位置</li>
                    <li><strong>分層切換</strong>：點擊上方分頁標籤切換不同類型的救災資訊</li>
                    <li><strong>搜尋過濾</strong>：在搜尋框輸入關鍵字過濾各層級的標記資訊</li>
                    <li><strong>填寫表單</strong>：點擊村里區域後可填寫救災資訊表單</li>
                    <li><strong>清單導航</strong>：點擊右側列表中的任一項目可快速定位到地圖上對應標記</li>
                </ul>
            </div>
            <div class="mb-4">
                <h6>資料來源：</h6>
                <ul>
                    <li><strong>救災目標</strong>：來源自 <a href="https://docs.google.com/spreadsheets/d/1s-6z7kqsRLUEsmetdquoBDbZugwYmHiRKYeWCdc-gP4/edit" target="_blank" class="text-decoration-none">Google 試算表</a>，包含清理進度、泥沙淤積狀況、廢棄家具移除等詳細資訊</li>
                    <li><strong>通報資訊</strong>：透過表單即時收集的救災需求與資源提供資訊</li>
                    <li><strong>服務設施</strong>：來源自 <a href="https://www.google.com/maps/d/u/0/viewer?mid=1euJJbnUwI0z0SNe4cWVcqzIDT6MMCrM" target="_blank" class="text-decoration-none">Google My Maps</a>，包含流動廁所、沐浴站、取水站、物資站、醫療站、疫苗接種站、寵物義診、志工服務站、安心關懷站等資訊</li>
                </ul>
            </div>
            <div class="alert alert-info">
                <strong>提醒：</strong>此地圖即時顯示透過表單提交的救災資訊，採用智慧分層與群組技術優化顯示效能，並支援精確定位與資訊分享功能，協助災區資源協調與需求媒合。救災目標採用1-6級優先分級制度，數字越小表示越需要協助。
            </div>
        </div>
    </div>
    <div class="modal fade" id="coordinatesModal" tabindex="-1" aria-labelledby="coordinatesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="coordinatesModalLabel">輸入座標</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="coordinatesInput" class="form-label">座標 (緯度,經度)</label>
                        <input type="text" class="form-control" id="coordinatesInput" placeholder="例如: 23.123456,120.123456">
                    </div>
                    <div class="mb-3">
                        <label for="latitude" class="form-label">緯度</label>
                        <input type="number" class="form-control" id="latitude" step="any" required>
                    </div>
                    <div class="mb-3">
                        <label for="longitude" class="form-label">經度</label>
                        <input type="number" class="form-control" id="longitude" step="any" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="zoomToCoordinates">確定</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="main.js"></script>
</body>
</html>